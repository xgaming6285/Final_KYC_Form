<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .camera-container {
            margin: 20px 0;
            text-align: center;
            position: relative;
        }
        #video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #canvas {
            display: none;
        }
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 640px;
            height: auto;
            z-index: 10;
            pointer-events: none;
        }
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn-disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status-message {
            background-color: #e7f3fe;
            color: #0d47a1;
            padding: 12px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        /* Removed comparison-container CSS since comparison elements are no longer used */
        .back-link {
            display: block;
            margin-top: 20px;
            text-align: center;
        }
        #result-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            text-align: center;
        }
        .success-result {
            background-color: #e7f9e7;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .failure-result {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .help-text {
            background-color: #fff3e0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        #loading-spinner {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Face Verification</h1>
    
    <div id="status-message">Please look at the camera for face verification</div>
    
    <div class="help-text">
        Position your face within the frame and ensure good lighting. Try to match the angle of your face with your ID photo.
    </div>
    
    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay-canvas"></canvas>
        <canvas id="canvas"></canvas>
    </div>

    <div id="loading-spinner">
        <div class="spinner"></div>
        <p>Processing... Please wait</p>
    </div>
    
    <div class="controls">
        <button id="captureBtn" class="btn">Capture</button>
        <button id="verifyBtn" class="btn btn-disabled" disabled>Verify Face</button>
    </div>
    
    <div id="video-status" style="
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 8px 15px;
        border-radius: 4px;
        margin: 10px 0;
        text-align: center;
        font-size: 0.9em;
        display: none;
    ">
        <span id="video-status-text">Video recording active</span>
        <span id="video-size" style="margin-left: 10px;"></span>
    </div>
    
    <div id="result-container">
        <h2 id="result-title">Verification Result</h2>
        <p id="result-message"></p>
        <button id="try-again-btn" class="btn">Try Again</button>
        <button id="complete-btn" class="btn">Complete KYC</button>
    </div>
    
    <!-- Removed comparison-container div that showed ID Photo and Your Captured Face -->
    
    <a href="/" class="back-link">Back to Home</a>
    
    <script>
        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const captureBtn = document.getElementById('captureBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        // saveVideoBtn removed for automatic video saving
        const statusMessage = document.getElementById('status-message');
        const resultContainer = document.getElementById('result-container');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const tryAgainBtn = document.getElementById('try-again-btn');
        const completeBtn = document.getElementById('complete-btn');
        const loadingSpinner = document.getElementById('loading-spinner');
        const videoStatus = document.getElementById('video-status');
        const videoStatusText = document.getElementById('video-status-text');
        const videoSize = document.getElementById('video-size');
        // Removed references to comparisonContainer, idPhoto, and capturedFace elements
        
        // Get session ID from localStorage
        const sessionId = localStorage.getItem('kyc_session_id');
        let capturedImageData = null;
        
        // Initialize camera
        async function initCamera() {
            try {
                console.log('üé• Initializing camera for face verification...');
                
                // Create camera stream directly for face verification - prioritize this over video recording
                let stream = null;
                
                try {
                    // Create camera stream directly for face verification with higher priority
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user', // Use front camera for face verification
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                    console.log('üì∑ Camera stream created successfully for face verification');
                } catch (cameraError) {
                    console.error('‚ùå Failed to create camera stream:', cameraError);
                    throw cameraError;
                }
                
                if (!stream) {
                    throw new Error('Could not access camera - no stream available');
                }
                
                video.srcObject = stream;
                
                // Ensure video actually starts playing immediately
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        console.error('‚ùå Camera initialization timeout');
                        reject(new Error('Camera initialization timeout'));
                    }, 10000); // 10 second timeout instead of 5
                    
                    video.onloadedmetadata = () => {
                        console.log('üìπ Video metadata loaded, starting playback...');
                        video.play().then(() => {
                            console.log('‚úÖ Video playback started successfully');
                            clearTimeout(timeoutId);
                            overlayCanvas.width = video.videoWidth;
                            overlayCanvas.height = video.videoHeight;
                            drawFaceOverlay();
                            statusMessage.textContent = "Camera ready. Position your face in the circle and click 'Capture'";
                            statusMessage.style.backgroundColor = "#e8f5e8";
                            statusMessage.style.color = "#2e7d32";
                            resolve();
                        }).catch((playError) => {
                            console.error('‚ùå Video playback failed:', playError);
                            clearTimeout(timeoutId);
                            reject(playError);
                        });
                    };
                    
                    video.onerror = (error) => {
                        console.error('‚ùå Video element error:', error);
                        clearTimeout(timeoutId);
                        reject(new Error('Video playback failed'));
                    };
                });
                
            } catch (err) {
                console.error("Error accessing camera:", err);
                
                // Provide more specific error messages
                let errorMessage = "Error accessing camera. ";
                
                if (err.name === 'NotAllowedError') {
                    errorMessage += "Camera permission was denied. Please allow camera access and refresh the page.";
                } else if (err.name === 'NotFoundError') {
                    errorMessage += "No camera found on this device.";
                } else if (err.name === 'NotReadableError') {
                    errorMessage += "Camera is already in use by another application. Please close other apps using the camera and try again.";
                } else if (err.name === 'AbortError') {
                    errorMessage += "Camera access was aborted.";
                } else if (err.name === 'NotSupportedError') {
                    errorMessage += "Camera access is not supported in this browser.";
                } else if (err.message && err.message.includes('timeout')) {
                    errorMessage += "Camera is taking too long to initialize. Please try again.";
                } else {
                    errorMessage += "Please ensure camera permissions are granted and try again.";
                }
                
                statusMessage.textContent = errorMessage;
                statusMessage.style.backgroundColor = "#ffebee";
                statusMessage.style.color = "#c62828";
                
                // Add retry button
                const retryButton = document.createElement('button');
                retryButton.textContent = 'Retry Camera Access';
                retryButton.className = 'btn';
                retryButton.style.marginTop = '10px';
                retryButton.onclick = async () => {
                    retryButton.remove();
                    statusMessage.textContent = "Retrying camera access...";
                    statusMessage.style.backgroundColor = "#e3f2fd";
                    statusMessage.style.color = "#1976d2";
                    await initCamera();
                };
                statusMessage.parentNode.insertBefore(retryButton, statusMessage.nextSibling);
                
                throw err;
            }
        }
        
        // Draw face position overlay
        function drawFaceOverlay() {
            const ctx = overlayCanvas.getContext('2d');
            ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            
            // Draw face outline guide
            const centerX = overlayCanvas.width / 2;
            const centerY = overlayCanvas.height / 2;
            const radius = Math.min(overlayCanvas.width, overlayCanvas.height) * 0.25;
            
            ctx.strokeStyle = 'rgba(76, 175, 80, 0.7)';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Add text instruction
            ctx.font = '20px Arial';
            ctx.fillStyle = 'rgba(76, 175, 80, 0.9)';
            ctx.textAlign = 'center';
            ctx.fillText('Position your face here', centerX, centerY - radius - 20);
        }
        
        // Capture face image
        captureBtn.addEventListener('click', () => {
            // Save video progress when capturing face
            if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                window.videoRecordingManager.saveCurrentVideoProgress();
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Get the image data
            capturedImageData = canvas.toDataURL('image/jpeg');
            
            // Show the captured image
            // Removed capturedFace.src = capturedImageData;
            
            // Enable verify button
            verifyBtn.classList.remove('btn-disabled');
            verifyBtn.disabled = false;
            
            // Update status
            statusMessage.textContent = "Face captured. Click 'Verify Face' to continue.";
        });
        
        // Verify face against ID photo
        verifyBtn.addEventListener('click', async () => {
            if (!capturedImageData) {
                alert('Please capture your face image first.');
                return;
            }
            
            if (!sessionId) {
                alert('Session ID not found. Please start the KYC process from the beginning.');
                return;
            }
            
            // Save video progress before verification
            if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                console.log('üíæ Saving video progress before face verification...');
                await window.videoRecordingManager.saveCurrentVideoProgress();
            }
            
            // Disable the button and show loading spinner
            verifyBtn.disabled = true;
            verifyBtn.classList.add('btn-disabled');
            captureBtn.disabled = true;
            captureBtn.classList.add('btn-disabled');
            loadingSpinner.style.display = 'block';
            statusMessage.textContent = "Verifying face... Please wait.";
            
            try {
                // Send the captured face to the server for verification
                const response = await fetch('/verify_face', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_data: capturedImageData,
                        session_id: sessionId
                    })
                });
                
                const result = await response.json();
                
                // Hide loading spinner
                loadingSpinner.style.display = 'none';
                
                // Show comparison images
                // Removed comparisonContainer.style.display = 'flex';
                // Removed idPhoto.src = result.id_photo_url;
                
                // Display verification result
                resultContainer.style.display = 'block';
                
                if (result.success) {
                    resultContainer.classList.add('success-result');
                    resultContainer.classList.remove('failure-result');
                    resultTitle.textContent = "Verification Successful";
                    resultMessage.textContent = "Your face matches with the ID photo. KYC process is complete.";
                    completeBtn.style.display = 'inline-block';
                    
                    // Save final video progress on successful verification
                    if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                        console.log('üíæ Saving final video progress - verification successful');
                        await window.videoRecordingManager.saveCurrentVideoProgress();
                    }
                } else {
                    resultContainer.classList.add('failure-result');
                    resultContainer.classList.remove('success-result');
                    resultTitle.textContent = "Verification Failed";
                    resultMessage.textContent = result.message || "Your face doesn't match the ID photo. Please try again.";
                    completeBtn.style.display = 'none';
                }
                
                // Update status
                statusMessage.textContent = result.success ? "Face verification successful!" : "Face verification failed";
                
            } catch (error) {
                console.error('Error during face verification:', error);
                loadingSpinner.style.display = 'none';
                statusMessage.textContent = "Error during face verification. Please try again.";
                verifyBtn.disabled = false;
                verifyBtn.classList.remove('btn-disabled');
                captureBtn.disabled = false;
                captureBtn.classList.remove('btn-disabled');
            }
        });
        
        // Try again button
        tryAgainBtn.addEventListener('click', () => {
            // Reset UI
            resultContainer.style.display = 'none';
            // Removed comparisonContainer.style.display = 'none';
            capturedImageData = null;
            verifyBtn.disabled = true;
            verifyBtn.classList.add('btn-disabled');
            captureBtn.disabled = false;
            captureBtn.classList.remove('btn-disabled');
            statusMessage.textContent = "Please look at the camera for face verification";
        });
        
        // Complete KYC button - handler will be replaced below with improved version
        
        // Automatic video saving implemented - no manual save button needed
        
        // Update video status periodically
        function updateVideoStatus() {
            if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                const status = window.videoRecordingManager.getStatus();
                
                if (status.isRecording) {
                    videoStatus.style.display = 'block';
                    videoStatusText.textContent = `Recording: ${status.recordingDuration.toFixed(0)}s`;
                    
                    // Calculate approximate size and show chunk information
                    let totalSize = 0;
                    let totalChunks = 0;
                    let cameraInfo = [];
                    
                    if (window.videoRecordingManager.videoChunks) {
                        Object.keys(window.videoRecordingManager.videoChunks).forEach(cameraType => {
                            const chunks = window.videoRecordingManager.videoChunks[cameraType];
                            if (chunks && chunks.length > 0) {
                                const cameraSize = chunks.reduce((sum, chunk) => sum + chunk.size, 0);
                                totalSize += cameraSize;
                                totalChunks += chunks.length;
                                cameraInfo.push(`${cameraType}: ${chunks.length} chunks (${(cameraSize / 1024 / 1024).toFixed(1)}MB)`);
                            }
                        });
                    }
                    
                    if (totalSize > 0) {
                        videoSize.textContent = `(${(totalSize / 1024 / 1024).toFixed(1)} MB, ${totalChunks} chunks)`;
                        if (cameraInfo.length > 0) {
                            videoSize.title = cameraInfo.join(', '); // Show detailed info on hover
                        }
                    } else {
                        videoSize.textContent = '(accumulating...)';
                    }
                } else {
                    videoStatus.style.display = 'none';
                }
            } else {
                videoStatus.style.display = 'none';
            }
        }
        
        // Start video status updates
        setInterval(updateVideoStatus, 2000);
        
        // Camera initialization is now handled by DOMContentLoaded event with proper timing
    </script>
    
    <!-- Include video recording functionality -->
    <script src="/static/js/video-recorder.js"></script>
    <script>
        // Initialize video recording for face verification page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üë§ Face verification page loaded - setting up video recording...');
            
            // Get session ID from localStorage
            let sessionId = localStorage.getItem('kyc_session_id');
            if (!sessionId) {
                sessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                localStorage.setItem('kyc_session_id', sessionId);
            }
            
            // Add recording notification banner for face verification
            const notification = document.createElement('div');
            notification.id = 'recording-notification';
            notification.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #dc3545, #c82333);
                    color: white;
                    padding: 10px 20px;
                    text-align: center;
                    font-weight: 500;
                    box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
                    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
                    font-size: 14px;
                ">
                    <i class="fas fa-video" style="margin-right: 8px;"></i>
                    <strong>Session Recording Active</strong> - Final verification step being recorded
                </div>
            `;
            document.body.insertBefore(notification, document.body.firstChild);
            
            // Initialize face verification camera FIRST and immediately
            console.log('üì∑ Starting immediate camera initialization...');
            try {
                await initCamera(); // Await the promise
                console.log('‚úÖ Face verification camera initialized successfully');
            } catch (error) {
                console.error('‚ùå Face verification camera initialization failed:', error);
                // Don't proceed with video recording if camera fails
                return;
            }
            
            // AFTER camera is working, initialize video recording in background
            // Wait a bit to ensure camera is stable before starting video recording
            setTimeout(async () => {
                try {
                    console.log('üé• Initializing background video recording (after camera is stable)...');
                    
                    if (!window.videoRecordingManager) {
                        console.error('‚ùå Video recording manager not available');
                        return;
                    }
                    
                    console.log('‚úÖ Video recording manager is available');
                    console.log('üìç Current recording state:', window.videoRecordingManager.isRecording);
                    
                    if (!window.videoRecordingManager.isRecording) {
                        console.log('üîÑ Initializing new video recording session...');
                        // Initialize video recording session
                        const initialized = await window.videoRecordingManager.initializeSession(sessionId);
                        
                        if (initialized) {
                            console.log('‚úÖ Video recording session initialized for face verification');
                            
                            // Start recording in background mode (separate from face verification camera)
                            try {
                                console.log('‚ñ∂Ô∏è Starting video recording...');
                                await window.videoRecordingManager.startRecording();
                                console.log('‚úÖ Background video recording started successfully');
                                
                                // Set up auto-save interval for video recording (less frequent during face verification)
                                if (window.videoRecordingManager.autoSaveInterval) {
                                    clearInterval(window.videoRecordingManager.autoSaveInterval);
                                }
                                
                                window.videoRecordingManager.autoSaveInterval = setInterval(async () => {
                                    if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                                        console.log('üíæ Auto-saving video progress during face verification...');
                                        await window.videoRecordingManager.saveCurrentVideoProgress();
                                    }
                                }, 15000); // Every 15 seconds
                                
                            } catch (recordingError) {
                                console.warn('‚ö†Ô∏è Background video recording failed:', recordingError.message);
                                console.error('üìÑ Full recording error:', recordingError);
                                // Continue without video recording if it fails
                            }
                        } else {
                            console.error('‚ùå Failed to initialize video recording session');
                        }
                    } else {
                        console.log('‚ÑπÔ∏è Video recording already active - continuing session');
                        // Save current progress
                        await window.videoRecordingManager.saveCurrentVideoProgress();
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Background video recording setup failed:', error.message);
                    console.error('üìÑ Full setup error:', error);
                    // Continue without video recording if it fails
                }
            }, 2000); // 2 second delay to ensure camera is stable
        });
        
        // Complete KYC and upload final video
        const originalCompleteHandler = completeBtn.onclick;
        completeBtn.onclick = async function() {
            // Disable button to prevent double-clicks
            completeBtn.disabled = true;
            completeBtn.textContent = 'Completing KYC...';
            
            console.log('üèÅ Starting KYC completion process...');
            
            try {
                let videoUploadSuccess = false;
                let videoUploadMessage = '';
                
                // Upload final video to S3 when completing KYC
                if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                    console.log('‚òÅÔ∏è Finalizing video recording and uploading to S3...');
                    
                    // First, save any remaining video chunks
                    await window.videoRecordingManager.saveCurrentVideoProgress();
                    console.log('üíæ Final video progress saved');
                    
                    // Update button text to show upload progress
                    completeBtn.textContent = 'Preparing video...';
                    
                    // Wait a moment for any final chunks to be processed
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Upload final consolidated video to S3
                    console.log('üì§ Uploading final video to S3...');
                    completeBtn.textContent = 'Uploading video...';
                    
                    try {
                        const uploadResult = await window.videoRecordingManager.uploadFinalVideoToS3();
                        
                        if (uploadResult.success) {
                            console.log('‚úÖ Final video uploaded successfully:', uploadResult);
                            videoUploadSuccess = true;
                            videoUploadMessage = uploadResult.message || 'Video uploaded successfully';
                            statusMessage.textContent = `Video uploaded successfully (${uploadResult.message || 'Upload complete'})`;
                            statusMessage.style.backgroundColor = "#e8f5e8";
                            statusMessage.style.color = "#2e7d32";
                        } else {
                            console.error('‚ùå Failed to upload final video to S3:', uploadResult.error);
                            videoUploadMessage = `Video upload failed: ${uploadResult.error}`;
                            statusMessage.textContent = `Warning: ${uploadResult.error} - KYC will complete without video.`;
                            statusMessage.style.backgroundColor = "#fff3cd";
                            statusMessage.style.color = "#856404";
                        }
                    } catch (uploadError) {
                        console.error('‚ùå Exception during video upload:', uploadError);
                        videoUploadMessage = `Video upload error: ${uploadError.message}`;
                        statusMessage.textContent = `Warning: Video upload failed - KYC will complete without video.`;
                        statusMessage.style.backgroundColor = "#fff3cd";
                        statusMessage.style.color = "#856404";
                    }
                    
                    // Stop recording after upload attempt
                    console.log('üõë Stopping video recording...');
                    window.videoRecordingManager.stopRecording();
                    
                } else {
                    console.log('‚ÑπÔ∏è No active video recording to upload');
                    videoUploadMessage = 'No video recording was active';
                }
                
                // Clear any remaining intervals
                if (window.videoRecordingManager && window.videoRecordingManager.autoSaveInterval) {
                    clearInterval(window.videoRecordingManager.autoSaveInterval);
                    window.videoRecordingManager.autoSaveInterval = null;
                }
                
                // Clear session storage to complete KYC
                console.log('üßπ Cleaning up session data...');
                
                // Show success message
                completeBtn.textContent = 'KYC Complete!';
                completeBtn.style.backgroundColor = '#28a745';
                
                // Update final status message
                if (videoUploadSuccess) {
                    statusMessage.textContent = `KYC completed successfully! ${videoUploadMessage}`;
                    statusMessage.style.backgroundColor = "#e8f5e8";
                    statusMessage.style.color = "#2e7d32";
                } else {
                    statusMessage.textContent = `KYC completed! Note: ${videoUploadMessage}`;
                    statusMessage.style.backgroundColor = "#fff3cd";
                    statusMessage.style.color = "#856404";
                }
                
                // Brief delay to show success message
                setTimeout(() => {
                    console.log('üè† Redirecting to homepage...');
                    // Redirect to homepage
                    window.location.href = "/";
                }, 3000); // Increased delay to show message
                
            } catch (error) {
                console.error('‚ùå Error completing KYC:', error);
                completeBtn.disabled = false;
                completeBtn.textContent = 'Complete KYC';
                completeBtn.style.backgroundColor = '#4CAF50';
                
                // Show error message to user
                statusMessage.textContent = `Error completing KYC: ${error.message} Please try again.`;
                statusMessage.style.backgroundColor = "#ffebee";
                statusMessage.style.color = "#c62828";
            }
        };
        
        // Stop recording when user leaves the face verification page 
        window.addEventListener('beforeunload', async function(event) {
            if (window.videoRecordingManager && window.videoRecordingManager.isRecording) {
                console.log('üõë User leaving face verification page - saving and stopping video recording');
                
                try {
                    // Save current progress before leaving
                    await window.videoRecordingManager.saveCurrentVideoProgress();
                    console.log('üíæ Final video progress saved before page unload');
                } catch (error) {
                    console.error('‚ùå Error saving video progress before unload:', error);
                }
                
                // Stop recording
                window.videoRecordingManager.stopRecording();
                console.log('üõë Video recording stopped due to page unload');
            }
        });
    </script>
</body>
</html> 